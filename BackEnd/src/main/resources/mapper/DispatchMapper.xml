<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dasi.core.mapper.DispatchMapper">

    <select id="selectMailboxInfo" resultType="com.dasi.pojo.entity.Mailbox">
        SELECT
            c.inbox               AS inbox,
            dep.name              AS addresser,
            0                     AS is_read,
            0                     AS is_deleted,
            NOW()                 AS arrived_at,
            NULL                  AS read_at
        FROM dispatch d
        LEFT JOIN department dep ON d.department_id = dep.id
        LEFT JOIN contact c ON d.contact_id = c.id
        WHERE d.id = #{dispatchId}
        LIMIT 1
    </select>

    <select id="countByAccount" resultType="map">
        SELECT a.name AS name, COUNT(d.id) AS count
        FROM dispatch d
                 JOIN account a ON d.account_id = a.id
        GROUP BY a.id, a.name
        ORDER BY count DESC
        LIMIT 5
    </select>

    <select id="countByDepartment" resultType="map">
        SELECT dep.name AS name, COUNT(d.id) AS count
        FROM dispatch d
                 JOIN department dep ON d.department_id = dep.id
        GROUP BY dep.id, dep.name
        ORDER BY count DESC
        LIMIT 5
    </select>

    <select id="countByContact" resultType="map">
        SELECT c.name AS name, COUNT(d.id) AS count
        FROM dispatch d
                 JOIN contact c ON d.contact_id = c.id
        GROUP BY c.id, c.name
        ORDER BY count DESC
        LIMIT 5
    </select>

    <select id="countByChannel" resultType="map">
        SELECT channel AS name, COUNT(id) AS count
        FROM dispatch
        GROUP BY channel
        ORDER BY count DESC
    </select>

</mapper>